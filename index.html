<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC9ImykUXTxz62yQqlsmKwHvZVPJm8-DlM",
            authDomain: "bds-central-asia.firebaseapp.com",
            projectId: "bds-central-asia",
            storageBucket: "bds-central-asia.firebasestorage.app",
            messagingSenderId: "1090797281337",
            appId: "1:1090797281337:web:89fff1f4d9976328ec6de8",
            measurementId: "G-SRC4WVR687"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        // Initialize Firestore and Auth and set global references
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.doc = doc;
    window.setDoc = setDoc;
    window.getDoc = getDoc;
    </script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">

        <div class="flex justify-between items-center mb-6">
            <h1 class="text-xl font-bold text-gray-800" id="title-text"></h1>
            <select id="language-selector" class="rounded-lg p-2 bg-gray-100 text-gray-700">
                <option value="en">English</option>
                <option value="ru">Русский</option>
                <option value="ky">Кыргызча</option>
            </select>
        </div>

        <div id="scanner-container" class="space-y-4">
            <div id="scanner" class="w-full h-64 bg-gray-200 rounded-lg overflow-hidden"></div>
            <div id="scanner-buttons" class="flex justify-center space-x-2">
                <button id="start-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-blue-700 transition-colors">
                    <span id="start-text"></span>
                </button>
                <button id="stop-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-red-700 transition-colors hidden">
                    <span id="stop-text"></span>
                </button>
            </div>
            <p id="scanning-status" class="text-center text-sm font-medium text-gray-500"></p>
        </div>
        
        <div id="manual-input-section" class="mt-4 pt-4 border-t">
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                <input type="text" id="manual-barcode-input" placeholder="Enter barcode number" class="w-full rounded-lg p-2 border border-gray-300">
                <button id="manual-submit-btn" class="w-full sm:w-auto bg-gray-500 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-600 transition-colors">Submit</button>
            </div>
        </div>

        <div id="product-details" class="mt-6 border-t pt-4 hidden">
            <h2 class="text-lg font-semibold text-gray-800" id="result-title"></h2>
            <div id="product-info" class="mt-2 space-y-2">
                </div>
        </div>
        
        <div id="add-product-section" class="mt-8 pt-4 border-t hidden">
            <p id="add-product-message" class="text-center text-red-500 font-medium mb-4"></p>
            <h2 class="text-lg font-bold text-gray-800 mb-4">Add a New Product for Review</h2>
            <form id="add-product-form" class="space-y-4">
                <input type="text" id="add-barcode" placeholder="Barcode" required class="w-full rounded-lg p-2 border border-gray-300" readonly>
                <input type="text" id="add-name-en" placeholder="Product Name" required class="w-full rounded-lg p-2 border border-gray-300">
                <input type="text" id="add-company" placeholder="Company Name (Producer)" required class="w-full rounded-lg p-2 border border-gray-300">
                <label class="block text-sm font-medium text-gray-700">Product Image (Front)</label>
                <input type="file" id="add-image-front" accept="image/*" capture="environment" required class="w-full rounded-lg p-2 border border-gray-300">
                <label class="block text-sm font-medium text-gray-700">Product Image (Back)</label>
                <input type="file" id="add-image-back" accept="image/*" capture="environment" required class="w-full rounded-lg p-2 border border-gray-300">
                <label class="block text-sm font-medium text-gray-700">Product Image (Contents)</label>
                <input type="file" id="add-image-contents" accept="image/*" capture="environment" class="w-full rounded-lg p-2 border border-gray-300">
                <div class="flex justify-between space-x-2">
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-green-700 transition-colors">Submit for Review</button>
                    <button type="button" id="cancel-btn" class="w-full bg-gray-400 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-500 transition-colors">Cancel</button>
                </div>
            </form>
        </div>

    </div>

    <div id="message-box" class="fixed top-4 right-4 bg-gray-800 text-white text-sm px-4 py-2 rounded-lg shadow-xl z-50 transition-transform transform translate-x-full"></div>


    <script>
        // Use a dedicated global for the app state
        const App = {
            html5Qrcode: null,
            lastScannedResult: null,
        };

        const translations = {
            en: {
                title: 'Scan Product',
                start: 'Start Scanning',
                stop: 'Stop Scanning',
                scanning: 'Scanning...',
                resultTitle: 'Scanned Result:',
                notFound: 'Product not found. Please enter details below.',
                addProductMessage: 'Product not found. Please enter details below.',
                productAdded: 'Product added successfully!',
                failedToAdd: 'Failed to add product.',
                enterBarcode: 'Enter barcode number',
                safeStatus: 'Safe',
                notSafeStatus: 'Not Safe',
                underReviewStatus: 'Under Review'
            },
            ru: {
                title: 'Сканировать продукт',
                start: 'Начать сканирование',
                stop: 'Остановить сканирование',
                scanning: 'Сканирование...',
                resultTitle: 'Результат сканирования:',
                notFound: 'Продукт не найден. Пожалуйста, введите данные ниже.',
                addProductMessage: 'Продукт не найден. Пожалуйста, введите данные ниже.',
                productAdded: 'Продукт успешно добавлен!',
                failedToAdd: 'Не удалось добавить продукт.',
                enterBarcode: 'Введите номер штрих-кода',
                safeStatus: 'Безопасный',
                notSafeStatus: 'Небезопасный',
                underReviewStatus: 'На рассмотрении'
            },
            ky: {
                title: 'Продуктту скандаңыз',
                start: 'Сканерлөөнү баштоо',
                stop: 'Сканерлөөнү токтотуу',
                scanning: 'Сканерлеп жатат...',
                resultTitle: 'Сканерлөөнүн жыйынтыгы:',
                notFound: 'Продукт табылган жок. Сураныч, төмөндө маалыматтарды киргизиңиз.',
                addProductMessage: 'Продукт табылган жок. Сураныч, төмөндө маалыматтарды киргизиңиз.',
                productAdded: 'Продукт ийгиликтүү кошулду!',
                failedToAdd: 'Продукт кошуу мүмкүн болгон жок.',
                enterBarcode: 'Штрих-код номерин киргизиңиз',
                safeStatus: 'Коопсуз',
                notSafeStatus: 'Кооптуу',
                underReviewStatus: 'Каралууда'
            }
        };

        const elements = {
            languageSelector: document.getElementById('language-selector'),
            titleText: document.getElementById('title-text'),
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            startText: document.getElementById('start-text'),
            stopText: document.getElementById('stop-text'),
            scanningStatus: document.getElementById('scanning-status'),
            scanner: document.getElementById('scanner'),
            productDetails: document.getElementById('product-details'),
            resultTitle: document.getElementById('result-title'),
            productInfo: document.getElementById('product-info'),
            messageBox: document.getElementById('message-box'),
            addProductSection: document.getElementById('add-product-section'),
            addProductForm: document.getElementById('add-product-form'),
            addProductMessage: document.getElementById('add-product-message'),
            addBarcode: document.getElementById('add-barcode'),
            addCompany: document.getElementById('add-company'),
            // Updated to match the new form fields
            addImageFront: document.getElementById('add-image-front'),
            addImageBack: document.getElementById('add-image-back'),
            addImageContents: document.getElementById('add-image-contents'),
            addNameEn: document.getElementById('add-name-en'),
            cancelBtn: document.getElementById('cancel-btn'),
            manualBarcodeInput: document.getElementById('manual-barcode-input'),
            manualSubmitBtn: document.getElementById('manual-submit-btn')
        };
        
        // Function to show a temporary message box instead of `alert()`
        function showMessage(message, duration = 3000) {
            elements.messageBox.textContent = message;
            elements.messageBox.classList.remove('translate-x-full');
            elements.messageBox.classList.add('translate-x-0');

            setTimeout(() => {
                elements.messageBox.classList.remove('translate-x-0');
                elements.messageBox.classList.add('translate-x-full');
            }, duration);
        }

        function showSection(sectionId) {
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function hideSection(sectionId) {
            document.getElementById(sectionId).classList.add('hidden');
        }

        // Function to translate the UI based on the selected language
        function translateUI(lang) {
            const t = translations[lang];
            elements.titleText.textContent = t.title;
            elements.startText.textContent = t.start;
            elements.stopText.textContent = t.stop;
            elements.resultTitle.textContent = t.resultTitle;
            elements.scanningStatus.textContent = '';
            elements.addProductMessage.textContent = t.addProductMessage;
            elements.manualBarcodeInput.placeholder = t.enterBarcode;
            hideSection('product-details');
            hideSection('add-product-section');
        }

        // Function to handle the barcode scan success
        async function onScanSuccess(decodedText) {
            // Stop scanning once a result is found
            if (App.html5Qrcode && App.html5Qrcode.isScanning) {
                App.html5Qrcode.stop().then(() => {
                    elements.startBtn.classList.remove('hidden');
                    elements.stopBtn.classList.add('hidden');
                    elements.scanningStatus.textContent = '';
                }).catch(err => {
                    console.error("Failed to stop scanning.", err);
                });
            }
            
            const lang = elements.languageSelector.value;
            const t = translations[lang];
            elements.productInfo.innerHTML = ''; // Clear previous content

            try {
                // Get the product from Firestore (product collection)
                const productDocRef = doc(window.db, "product", decodedText);
                const productDoc = await getDoc(productDocRef);

                if (productDoc.exists()) {
                    const product = productDoc.data();
                    const productName = product.name?.en || '';
                    const imageFrontUrl = product.imageFrontUrl || '';
                    const imageBackUrl = product.imageBackUrl || '';
                    const imageContentsUrl = product.imageContentsUrl || '';
                    const reviewStatus = product.reviewStatus || 'pending'; // Get the status from the document
                    const producer = product.producer || '';

                    let imageHtml = '';
                    if (imageFrontUrl) {
                        imageHtml += `<img src="${imageFrontUrl}" class="rounded-lg shadow-sm mb-2" alt="${productName} (Front)" onerror="this.style.display='none'">`;
                    }
                    if (imageBackUrl) {
                        imageHtml += `<img src="${imageBackUrl}" class="rounded-lg shadow-sm mb-2" alt="${productName} (Back)" onerror="this.style.display='none'">`;
                    }
                    if (imageContentsUrl) {
                        imageHtml += `<img src="${imageContentsUrl}" class="rounded-lg shadow-sm mb-2" alt="${productName} (Contents)" onerror="this.style.display='none'">`;
                    }

                    // Dynamically set the status text and color based on reviewStatus
                    let statusText = '';
                    let statusColorClass = '';
                    switch (reviewStatus) {
                        case 'safe':
                            statusText = t.safeStatus;
                            statusColorClass = 'bg-green-200 text-green-800';
                            break;
                        case 'not safe':
                            statusText = t.notSafeStatus;
                            statusColorClass = 'bg-red-200 text-red-800';
                            break;
                        case 'pending':
                        default:
                            statusText = t.underReviewStatus;
                            statusColorClass = 'bg-yellow-200 text-yellow-800';
                            break;
                    }

                    let safetyHtml = `<span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${statusColorClass}">${statusText}</span>`;

                    elements.productInfo.innerHTML = `
                        ${imageHtml}
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <p class="font-bold text-lg">${productName}</p>
                            <p class="text-sm text-gray-800 font-semibold mt-1">Producer: ${producer}</p>
                            ${safetyHtml}
                        </div>
                        <p class="text-green-600 font-medium mt-2">Product found. If you want to review or update, please contact support.</p>
                    `;
                    showSection('product-details');
                    hideSection('add-product-section');
                } else {
                    // Product not found, show the add product form
                    showMessage('Product not found. Please add product info and upload images from two angles.');
                    elements.addBarcode.value = decodedText;
                    hideSection('scanner-container');
                    hideSection('product-details');
                    showSection('add-product-section');
                }
            } catch (error) {
                console.error("Error getting product data:", error);
                elements.productInfo.innerHTML = `<p class="text-red-500 font-medium">Error retrieving data.</p>`;
                showSection('product-details');
                hideSection('add-product-section');
            }
        }

        // Event listener for the language selector
        elements.languageSelector.addEventListener('change', (event) => {
            const lang = event.target.value;
            translateUI(lang);
        });

        // Event listener for manual barcode submission
        elements.manualSubmitBtn.addEventListener('click', () => {
            const barcode = elements.manualBarcodeInput.value;
            if (barcode) {
                onScanSuccess(barcode);
            } else {
                showMessage("Please enter a barcode number.");
            }
        });

        // Event listeners for the scanner buttons
        elements.startBtn.addEventListener('click', async () => {
            const lang = elements.languageSelector.value;
            const t = translations[lang];
            
            // Re-initialize the scanner on start
            App.html5Qrcode = new Html5Qrcode('scanner');

            // Improved config: larger qrbox and enable 1D barcodes
            const config = {
                fps: 10,
                qrbox: { width: 350, height: 350 }, // Larger area for easier scanning
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.CODE_93,
                    Html5QrcodeSupportedFormats.CODABAR
                ]
            };

            const preferredFacingMode = "environment";
            const fallbackFacingMode = "user";

            try {
                // Try to start with the preferred camera (back camera)
                await App.html5Qrcode.start({ facingMode: preferredFacingMode }, config, onScanSuccess);
            } catch (err) {
                console.error("Failed to start with environment camera, trying fallback:", err);
                // If that fails, try the user-facing camera as a fallback
                try {
                    await App.html5Qrcode.start({ facingMode: fallbackFacingMode }, config, onScanSuccess);
                } catch (fallbackErr) {
                    console.error("Failed to start with user camera.", fallbackErr);
                    elements.scanningStatus.textContent = "Error: Cannot access camera.";
                    showMessage("Error: Cannot access camera. Please check your browser's camera permissions.");
                    return; // Exit if both attempts fail
                }
            }

            // If we successfully started a camera (either one)
            elements.startBtn.classList.add('hidden');
            elements.stopBtn.classList.remove('hidden');
            elements.scanningStatus.textContent = t.scanning;
            hideSection('product-details');
            hideSection('add-product-section');
            showMessage(t.scanning);
        });

        elements.stopBtn.addEventListener('click', () => {
            if (App.html5Qrcode && App.html5Qrcode.isScanning) {
                App.html5Qrcode.stop().then(() => {
                    elements.startBtn.classList.remove('hidden');
                    elements.stopBtn.classList.add('hidden');
                    elements.scanningStatus.textContent = '';
                    showMessage(translations[elements.languageSelector.value].stop);
                }).catch(err => {
                    console.error("Failed to stop scanning.", err);
                });
            }
        });
        
        // Event listener for the cancel button
        elements.cancelBtn.addEventListener('click', () => {
            showSection('scanner-container');
            hideSection('add-product-section');
            elements.addProductForm.reset();
        });

        // Event listener for the add product form
        elements.addProductForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const barcode = elements.addBarcode.value;
            // Handle image uploads (front, back and contents)
            const imageFrontFile = elements.addImageFront.files[0];
            const imageBackFile = elements.addImageBack.files[0];
            const imageContentsFile = elements.addImageContents.files[0];

            // For demo: convert images to base64 (in production, upload to storage and save URLs)
            function toBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            let imageFrontBase64 = '';
            let imageBackBase64 = '';
            let imageContentsBase64 = '';
            // Added null checks to prevent errors if files aren't selected
            if (imageFrontFile) {
                imageFrontBase64 = await toBase64(imageFrontFile);
            }
            if (imageBackFile) {
                imageBackBase64 = await toBase64(imageBackFile);
            }
            if (imageContentsFile) {
                imageContentsBase64 = await toBase64(imageContentsFile);
            }

            const newProduct = {
                imageFront: imageFrontBase64,
                imageBack: imageBackBase64,
                imageContents: imageContentsBase64,
                name: {
                    en: elements.addNameEn.value,
                },
                company: elements.addCompany.value,
                reviewStatus: 'pending'
            };

            try {
                // Add the new product to Firestore (product collection)
                const productDocRef = doc(window.db, "product", barcode);
                await setDoc(productDocRef, newProduct);
                showMessage('Product submitted for review. Thank you!');
                elements.addProductForm.reset();
                showSection('scanner-container');
                hideSection('add-product-section');
            } catch (error) {
                console.error("Error adding product: ", error);
                showMessage('Failed to submit product for review.');
            }
        });

        // Initial UI translation on page load
        document.addEventListener('DOMContentLoaded', () => {
            translateUI('en');
        });
    </script>
</body>
</html>